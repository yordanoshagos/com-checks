generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
    // Further reading:
    // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
    url       = env("POSTGRES_PRISMA_URL")
    directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Session {
    id           String   @id @default(cuid())
    expiresAt    DateTime // renamed expires -> expiresAt
    token        String   @unique // renamed sessionToken -> token
    createdAt    DateTime @default(now())// added
    updatedAt    DateTime @updatedAt  @default(now()) // added
    ipAddress    String? // renamed ip -> uipAddress
    userAgent    String? // added
    userId       String
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    impersonatedBy       String?
    activeOrganizationId String?
}

model Account {
    id                    String    @id @default(cuid())
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt  @default(now())
}

model Verification { // renamed VerificationCode -> Verification
    id         String    @id @default(cuid())
    identifier String // renamed userId -> identifier
    value      String // renamed code -> value
    expiresAt  DateTime
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt  @default(now())
}

model User {
    id        String   @id @default(cuid())
    name      String?
    firstName String?
    image String? // added
    location  String?
    interests String[]
    aiUsage   String?
    url     String?

    role String?
    banned Boolean?
    banReason String?
    banExpires DateTime?
    members Member[]
    invitations Invitation[]

    email         String?     @unique
    emailVerified Boolean     @default(false) // added
    emails        UserEmail[]
    sessions      Session[]
    accounts Account[]
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt  @default(now()) // added
    isAdmin       Boolean     @default(false)
    isBetaUser    Boolean     @default(false)

    marketingEmails Boolean @default(true)
    productUpdates  Boolean @default(true)

    chats             Chat[]
    workspaceDocuments WorkspaceDocument[]

    Subject Subject[]
    researchRequests ResearchRequest[]
    subscriptions Subscription[] // Individual subscriptions by this user
    seatAllocations SeatAllocation[] // Seats allocated to this user from team subscriptions
}

model UserEmail {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String   @unique
  isPrimary Boolean  @default(false)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())
  
  @@unique([userId, email])
  @@index([userId])
  @@index([email])
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String? @unique
  logo        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt  @default(now())
  metadata    String?
  domain      String?
  members     Member[]
  invitations Invitation[]

  domains Domain[]

  freeForever    Boolean @default(false)
  subscriptions  Subscription[] // Team subscriptions purchased by this org

  trialEndsAt DateTime?
  trialChatCount Int @default(5)
  subjects         Subject[]
  chats            Chat[]
  researchRequests ResearchRequest[]
  workspaceDocuments WorkspaceDocument[]
}

model Domain {
  id             String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  domain         String 
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt  @default(now()) 

  @@unique([domain])
  @@map("domain")
}

enum MemberRole {
  ADMIN
  MEMBER
  VIEWER
}

model Member {
  id             String @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationEmail String?
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           MemberRole @default(MEMBER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt  @default(now())

  @@unique([userId, organizationId])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELED
}

enum InvitationType {
  INVITATION
  JOIN_REQUEST
}

model Invitation {
  id             String @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           MemberRole @default(MEMBER)
  status         InvitationStatus @default(PENDING)
  type           InvitationType @default(INVITATION)
  token          String?    @unique
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  message        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt  @default(now())
}



enum ChatType {
    ANALYSIS
    COUNTERPOINT
    BIAS
    SUMMARY
    BOARD_MEMO
    COMPREHENSIVE_REPORT
    DISCUSSION_QUESTIONS
    FINANCIAL_ANALYSIS
    LANDSCAPE_ANALYSIS
    LEADERSHIP_ANALYSIS
    PROGRAM_ANALYSIS
    RELEVANT_RESEARCH
    SITE_VISIT_PREP_GUIDE
    STRATEGIC_PLANNING_GUIDE
}

model Chat {
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt  @default(now())
    title      String?
    userId     String
    user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

    type ChatType @default(ANALYSIS)

    // Relations to Subject
    Subject   Subject? @relation("SubjectChats", fields: [SubjectId], references: [id])
    SubjectId String?


    messages Message[]
    votes    Vote[]
    streams  Stream[]

    @@index([organizationId])
    @@index([userId, organizationId])
}

model Message {
    id          String   @id @default(cuid())
    chatId      String
    chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
    role        String
    parts       Json
    attachments Json
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt  @default(now())
    votes Vote[]
}
model Vote {
    chatId    String
    messageId String
    isUpvoted Boolean
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt  @default(now())

    chat    Chat    @relation(fields: [chatId], references: [id], onDelete: Cascade)
    message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

    @@id([chatId, messageId])
}
model ResearchDocument {
    id                     String   @id @default(cuid())
    abstract              String   @db.Text
    citation              String   @db.Text
    studyTitle           String   @db.Text
    studyLink            String
    gdiveLink            String?
    metaAnalysisTitle    String?  @db.Text
    wsippLink            String?
    gdriveMetaAnalysisLink String?
    status               String
    fileUrl              String?
    fileType             String?
    wordCount            Int?
    uploadDate           DateTime

    abstractEmbedding     Unsupported("vector(1536)")?


    isArchived Boolean @default(false)

    chunks               ResearchDocumentChunk[]

    createdAt            DateTime @default(now())
    updatedAt            DateTime @updatedAt  @default(now())

    @@index([status])
    @@index([uploadDate])
}

model ResearchDocumentChunk {
    id          String   @id @default(cuid())
    chunkId     String
    content     String   @db.Text
    section     String
    embedding     Unsupported("vector(1536)")?

    document    ResearchDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
    documentId  String

    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt  @default(now())

    @@index([documentId])
    @@index([chunkId])
}

model Subject {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt  @default(now())

    createdBy User @relation(fields: [createdById], references: [id])
    createdById String
    
    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    
    isArchived Boolean @default(false)

    title String?
    context String
    documents WorkspaceDocument[]

    contextEmbedding Unsupported("vector(1536)")?

    // All chats that belong to this program evaluation
    chats Chat[] @relation("SubjectChats")

    researchRequest ResearchRequest?

    @@index([organizationId])
    @@index([createdById, organizationId])
}

model ResearchRequest {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt  @default(now())

    createdBy User @relation(fields: [createdById], references: [id])
    createdById String
    organizationId String?
    organizationRef Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

    subjectId String?
    subject Subject? @relation(fields: [subjectId], references: [id])

    withExpertReview Boolean @default(false)

    context String?

    contactName String?
    email String?
    organization String?
    researchTitle String?
    researchObjective String?
    sectorFocus String?
    selectedService String?

    documents WorkspaceDocument[]

    @@index([organizationId])
    @@index([createdById, organizationId])
    @@index([subjectId])
    @@unique([subjectId])
}

model WorkspaceDocument {
    id          String   @id @default(cuid())
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt  @default(now())

    name        String
    llmSummary     String?   @db.Text
    pageCount   Int?
    fileType    String
    supabaseURL String
    rawText String?
    rawTextWordCount Int?

    addedBy     User    @relation(fields: [addedById], references: [id])
    addedById   String
    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

    researchRequests ResearchRequest[]
    Subjects Subject[]

    @@index([organizationId])
    @@index([addedById, organizationId])
}

model Stream {
    id        String   @id @default(cuid())
    chatId    String
    chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt  @default(now())

    @@index([chatId])
}

enum SubscriptionPlan {
    Standard
    First100
    FirstYear
}

enum SubscriptionType {
    Individual // User pays for themselves
    Team       // Organization admin pays for team members
}

enum SubscriptionStatus {
    active // The subscription is active and can be used
    canceled // The subscribption can still be used, but will be canceled at period end
    retired // The subscription has been canceled and expired, it is kept for archival reasons only
}

enum SubscriptionRetirementReason {
  unpaid
  canceledByUser
}

model Subscription {
    id              String @id @default(cuid())
    userId          String? // For individual subscriptions
    organizationId  String? // For team subscriptions
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    status  SubscriptionStatus
    plan    SubscriptionPlan @default(Standard)
    seats Int @default(1) // Number of seats purchased
    type  SubscriptionType @default(Individual) // Individual or Team

    retirementReason     SubscriptionRetirementReason?
    pastDue              Boolean @default(false)

    stripeCustomerId     String
    stripeSubscriptionId String @unique
    periodStart          DateTime
    periodEnd            DateTime

    user         User? @relation(fields: [userId], references: [id])
    organization Organization? @relation(fields: [organizationId], references: [id])
    
    // Seat allocations for team subscriptions
    seatAllocations SeatAllocation[]
}

model SeatAllocation {
    id             String @id @default(cuid())
    subscriptionId String
    userId         String
    allocatedAt    DateTime @default(now())
    revokedAt      DateTime?
    
    subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
    user          User @relation(fields: [userId], references: [id])
    
    @@unique([subscriptionId, userId])
}
 
